<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>📊 דוח פיננסי</title>

  <style>
    /* --- אותו CSS שלך --- */
    @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@400;700&display=swap');
body {
  font-family: 'Heebo', sans-serif;
  background: #fafafa;
  margin: 0;
  padding: 16px 12px;
  color: #34495e;
  direction: rtl;
  line-height: 1.4;
}

h1 {
  text-align: center;
  font-size: 2rem;
  color: #2c3e50;
  margin-bottom: 24px;
  font-weight: 700;
  letter-spacing: 0.03em;
}

.nav-buttons {
  text-align: center;
  margin-bottom: 24px;
}

.nav-button {
  background: linear-gradient(135deg, #2a80b9, #1c5980);
  color: #fff;
  border: none;
  padding: 10px 22px;
  margin: 0 6px;
  border-radius: 20px;
  font-family: 'Heebo', sans-serif;
  font-size: 1rem;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.25s ease;
  box-shadow: 0 3px 10px rgba(42, 128, 185, 0.25);
  min-width: 100px;
}

.nav-button:hover {
  background: linear-gradient(135deg, #1c5980, #14506a);
  box-shadow: 0 5px 16px rgba(28, 89, 128, 0.35);
  transform: translateY(-1.5px);
}

.nav-button.active {
  background: linear-gradient(135deg, #16a085, #0e6d5c);
  box-shadow: 0 4px 14px rgba(22, 160, 133, 0.35);
}

.container {
  max-width: 600px;
  margin: 0 auto;
}

.card {
  background: #fff;
  border-radius: 12px;
  padding: 18px 20px;
  box-shadow: 0 3px 10px rgba(0,0,0,0.07);
  transition: box-shadow 0.3s ease;
  margin-top: 12px;
  font-size: 0.95rem;
}

.card:hover {
  box-shadow: 0 6px 18px rgba(0,0,0,0.12);
}

.date {
  font-weight: 700;
  font-size: 1.15rem;
  color: #16a085;
  border-bottom: 2px solid #16a085;
  margin-bottom: 14px;
  padding-bottom: 5px;
  letter-spacing: 0.02em;
}

.item {
  margin-bottom: 10px;
  display: flex;
  justify-content: space-between;
  border-bottom: 1px solid #e0e6e9;
  padding-bottom: 5px;
  color: #4a5a6a;
}

.item:last-child {
  border: none;
  margin-bottom: 0;
}

.notes {
  display: flex;
  align-items: center;
  font-weight: 600;
  color: #27ae60;
  margin-top: 8px;
  font-size: 0.95rem;
}

.notes.negative {
  color: #e74c3c;
}

#history-view {
  display: none;  /* מסתיר כברירת מחדל */
  text-align: center;
}

select {
  display: inline-block;
  width: 280px;
  max-width: 100%;
}

select {
  font-size: 1rem;
  padding: 7px 10px;
  border-radius: 8px;
  border: 1.5px solid #16a085;
  margin-bottom: 18px;
  width: 100%;
  max-width: 280px;
  direction: ltr;
  outline-offset: 2px;
  transition: border-color 0.3s ease;
}

select:focus {
  border-color: #1abc9c;
  box-shadow: 0 0 6px rgba(22, 188, 156, 0.5);
}

  </style>
</head>
<body>

  <h1>דוח פיננסי 📊</h1>
  
  <div class="nav-buttons">
    <button class="nav-button active" onclick="showCurrentReport()">📊 דוח נוכחי</button>
    <button class="nav-button" onclick="showHistory()">📈 היסטוריה</button>
  </div>

  <div id="current-view" class="container">
    <div id="container">טוען נתונים...</div>
  </div>

  <div id="history-view" class="container">
    <select id="dateSelect" onchange="onDateChange()">
      <option value="" disabled selected>בחר תאריך</option>
    </select>
    <div id="history-card" class="card" style="display:none;"></div>
  </div>

<script>
  let currentView = 'current';
  let historyData = [];

  function showCurrentReport() {
    currentView = 'current';
    document.getElementById('current-view').style.display = 'block';
    document.getElementById('history-view').style.display = 'none';
    document.querySelectorAll('.nav-button')[0].classList.add('active');
    document.querySelectorAll('.nav-button')[1].classList.remove('active');
  }

  function showHistory() {
    currentView = 'history';
    document.getElementById('current-view').style.display = 'none';
    document.getElementById('history-view').style.display = 'block';
    document.querySelectorAll('.nav-button')[0].classList.remove('active');
    document.querySelectorAll('.nav-button')[1].classList.add('active');
    
    if (historyData.length === 0) {
      loadHistoryData();
    }
  }

  function renderCard(data, containerId = 'container') {
    const container = document.getElementById(containerId);
    container.innerHTML = '';

    const growthPercentFormatted = (typeof data.growthPercentRaw === 'number')
      ? (data.growthPercentRaw * 100).toFixed(2) + '%'
      : data.growthPercentRaw;

    let growthColor = '#000';
    if (typeof data.growthPercentRaw === 'number') {
      if (data.growthPercentRaw > 0) growthColor = '#27ae60';
      else if (data.growthPercentRaw < 0) growthColor = '#e74c3c';
    }

    const notesClass = data.notesStatus === 'positive' ? '' : 'negative';

    // תוכן הכרטיסיה בלי העטיפה
    const innerHTML = `
      <div class="date">🗓️ חודש שיא: ${data.peakGrowthDate || data.date}</div>
      <div class="item"><strong>💰 מזומן:</strong> ${data.cash.toLocaleString('he-IL', {style:'currency', currency:'ILS'})}</div>
      <div class="item"><strong>🏦 עו"ש:</strong> ${data.currentAcc.toLocaleString('he-IL', {style:'currency', currency:'ILS'})}</div>
      <div class="item"><strong>🏛️ פיקדון (4%):</strong> ${data.deposit.toLocaleString('he-IL', {style:'currency', currency:'ILS'})}</div>
      <div class="item"><strong>🎓 קרן השתלמות:</strong> ${data.savingsFund.toLocaleString('he-IL', {style:'currency', currency:'ILS'})}</div>
      <div class="item"><strong>🛡️ קרן פנסיה:</strong> ${data.pensionFund.toLocaleString('he-IL', {style:'currency', currency:'ILS'})}</div>
      <div class="item"><strong>📈 סך נכסים נוכחי:</strong> ${data.totalAssets.toLocaleString('he-IL', {style:'currency', currency:'ILS'})}</div>
      <div class="item"><strong>📊 צמיחה:</strong> ${data.growth.toLocaleString('he-IL', {style:'currency', currency:'ILS'})}</div>
      <div class="item"><strong>📉 אחוז צמיחה:</strong> <span style="color:${growthColor}; font-weight: bold;">${growthPercentFormatted}</span></div>
      ${data.avgGrowth !== undefined ? `<div class="item"><strong>📅 צמיחה ממוצעת:</strong> ${data.avgGrowth.toLocaleString('he-IL', {style:'currency', currency:'ILS'})}</div>` : ''}
      ${data.notes ? `<div class="item notes ${notesClass}">${data.notes}</div>` : ''}
    `;

    if (containerId === 'container') {
      // דוח נוכחי - עטיפה בכרטיסיה
      container.innerHTML = `<div class="card">${innerHTML}</div>`;
    } else {
      // דוח היסטוריה - כבר עטוף בכרטיסיה (האלמנט עצמו הוא כרטיסיה)
      container.innerHTML = innerHTML;
    }
  }

  function parseGoogleSheetsData(response) {
    try {
      const row = response.table.rows[0].c;
      const data = {
        cash: row[0]?.v || 0,
        currentAcc: row[1]?.v || 0,
        deposit: row[2]?.v || 0,
        savingsFund: row[3]?.v || 0,
        pensionFund: row[4]?.v || 0,
        totalAssets: row[5]?.v || 0,
        growth: row[6]?.v || 0,
        growthPercentRaw: row[7]?.v || 0,
        peakGrowthDate: row[8]?.f || '—',
        avgGrowth: row[9]?.v || 0,
        notes: row[10]?.v || 'אין הערות',
        notesStatus: (row[10]?.v || '').includes('✅') ? 'positive' : 'negative'
      };
      renderCard(data, 'container');
    } catch (err) {
      document.getElementById('container').innerHTML = '<p class="error">שגיאה בעיבוד הנתונים</p>';
    }
  }

  function parseHistoryData(response) {
    try {
      const rows = response.table.rows;
      historyData = rows.map(row => {
        const c = row.c;
        return {
          date: c[0]?.f || c[0]?.v || '—',
          cash: c[1]?.v || 0,
          currentAcc: c[2]?.v || 0,
          deposit: c[3]?.v || 0,
          savingsFund: c[4]?.v || 0,
          pensionFund: c[5]?.v || 0,
          totalAssets: c[6]?.v || 0,
          growth: c[7]?.v || 0,
          growthPercentRaw: c[8]?.v || 0,
        };
      });

      populateDateSelect();
    } catch (err) {
      document.getElementById('history-view').innerHTML = '<p class="error">שגיאה בעיבוד נתוני ההיסטוריה</p>';
    }
  }

  function populateDateSelect() {
    const select = document.getElementById('dateSelect');
    select.innerHTML = '<option value="" disabled selected>בחר תאריך</option>';
    historyData.forEach((item, index) => {
      const option = document.createElement('option');
      option.value = index;
      option.textContent = item.date;
      select.appendChild(option);
    });
  }

  function onDateChange() {
    const select = document.getElementById('dateSelect');
    const idx = select.value;
    if (idx !== '') {
      const data = historyData[idx];
      if (data) {
        document.getElementById('history-card').style.display = 'block';
        renderCard(data, 'history-card');
      }
    }
  }

  function loadHistoryData() {
    const script = document.createElement('script');
    script.src = "https://docs.google.com/spreadsheets/d/19dofQI-ay91ZAq40-fySZMdh_riryWmXGpqdbvqVb34/gviz/tq?tqx=out:jsonp&sheet=מעקב%20חסכונות&gid=353171664";
    script.onerror = () => {
      document.getElementById('history-view').innerHTML = '<p class="error">אירעה שגיאה בטעינת נתוני ההיסטוריה.</p>';
    };
    document.body.appendChild(script);

    window.google = { visualization: { Query: { setResponse: parseHistoryData } } };
  }

  // טעינת הדוח הנוכחי בהתחלה
  const script = document.createElement('script');
  script.src = "https://docs.google.com/spreadsheets/d/19dofQI-ay91ZAq40-fySZMdh_riryWmXGpqdbvqVb34/gviz/tq?tqx=out:jsonp&sheet=סיכום%20חסכונות&gid=425922794";
  script.onerror = () => {
    document.getElementById('container').innerHTML = '<p class="error">אירעה שגיאה בטעינת הדו"ח.</p>';
  };
  document.body.appendChild(script);

  window.google = { visualization: { Query: { setResponse: parseGoogleSheetsData } } };
</script>

</body>
</html>
