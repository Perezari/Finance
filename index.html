<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>📊 דוח פיננסי</title>

  <style>
    /* --- אותו CSS שלך --- */
    @import url('https://fonts.googleapis.com/css2?family=Heebo:wght@400;700&display=swap');
    body {
      font-family: 'Heebo', sans-serif;
      background: #f0f2f5;
      margin: 0;
      padding: 20px;
      color: #2c3e50;
      direction: rtl;
    }
    h1 {
      text-align: center;
      font-size: 2.5rem;
      color: #34495e;
      margin-bottom: 30px;
    }
    .nav-buttons {
      text-align: center;
      margin-bottom: 30px;
    }
    .nav-button {
      background: linear-gradient(135deg, #3498db, #2980b9);
      color: white;
      border: none;
      padding: 12px 24px;
      margin: 0 10px;
      border-radius: 25px;
      font-family: 'Heebo', sans-serif;
      font-size: 1.1rem;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 4px 15px rgba(52, 152, 219, 0.3);
    }
    .nav-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 6px 20px rgba(52, 152, 219, 0.4);
    }
    .nav-button.active {
      background: linear-gradient(135deg, #1abc9c, #16a085);
      box-shadow: 0 4px 15px rgba(26, 188, 156, 0.3);
    }
    .container {
      max-width: 700px;
      margin: 0 auto;
    }
    .card {
      background: white;
      border-radius: 15px;
      padding: 24px;
      box-shadow: 0 4px 18px rgba(0,0,0,0.1);
      transition: 0.25s ease;
      margin-top: 10px;
    }
    .date {
      font-weight: 700;
      font-size: 1.3rem;
      color: #1abc9c;
      border-bottom: 2px solid #1abc9c;
      margin-bottom: 16px;
      padding-bottom: 6px;
    }
    .item {
      margin-bottom: 12px;
      font-size: 1.05rem;
      display: flex;
      justify-content: space-between;
      border-bottom: 1px solid #ecf0f1;
      padding-bottom: 6px;
    }
    .item:last-child {
      border: none;
      margin-bottom: 0;
    }
    .notes {
      display: flex;
      align-items: center;
      font-weight: bold;
      color: #27ae60;
      margin-top: 10px;
    }
    .notes.negative {
      color: #e74c3c;
    }
    #history-view {
      display: none;
    }
    select {
      font-size: 1.1rem;
      padding: 8px 12px;
      border-radius: 10px;
      border: 1.5px solid #1abc9c;
      margin-bottom: 20px;
      width: 100%;
      max-width: 300px;
      direction: ltr;
    }
  </style>
</head>
<body>

  <h1>דוח פיננסי 📊</h1>
  
  <div class="nav-buttons">
    <button class="nav-button active" onclick="showCurrentReport()">📊 דוח נוכחי</button>
    <button class="nav-button" onclick="showHistory()">📈 היסטוריה</button>
  </div>

  <div id="current-view" class="container">
    <div id="container">טוען נתונים...</div>
  </div>

  <div id="history-view" class="container">
    <select id="dateSelect" onchange="onDateChange()">
      <option value="" disabled selected>בחר תאריך</option>
    </select>
    <div id="history-card" class="card" style="display:none;"></div>
  </div>

<script>
  let currentView = 'current';
  let historyData = [];

  function showCurrentReport() {
    currentView = 'current';
    document.getElementById('current-view').style.display = 'block';
    document.getElementById('history-view').style.display = 'none';
    document.querySelectorAll('.nav-button')[0].classList.add('active');
    document.querySelectorAll('.nav-button')[1].classList.remove('active');
  }

  function showHistory() {
    currentView = 'history';
    document.getElementById('current-view').style.display = 'none';
    document.getElementById('history-view').style.display = 'block';
    document.querySelectorAll('.nav-button')[0].classList.remove('active');
    document.querySelectorAll('.nav-button')[1].classList.add('active');
    
    if (historyData.length === 0) {
      loadHistoryData();
    }
  }

  function renderCard(data, containerId = 'container') {
    const container = document.getElementById(containerId);
    container.innerHTML = '';

    const growthPercentFormatted = (typeof data.growthPercentRaw === 'number')
      ? (data.growthPercentRaw * 100).toFixed(2) + '%'
      : data.growthPercentRaw;

    let growthColor = '#000';
    if (typeof data.growthPercentRaw === 'number') {
      if (data.growthPercentRaw > 0) growthColor = '#27ae60';
      else if (data.growthPercentRaw < 0) growthColor = '#e74c3c';
    }

    const notesClass = data.notesStatus === 'positive' ? '' : 'negative';

    // תוכן הכרטיסיה בלי העטיפה
    const innerHTML = `
      <div class="date">🗓️ חודש שיא: ${data.peakGrowthDate || data.date}</div>
      <div class="item"><strong>💰 מזומן:</strong> ${data.cash.toLocaleString('he-IL', {style:'currency', currency:'ILS'})}</div>
      <div class="item"><strong>🏦 עו"ש:</strong> ${data.currentAcc.toLocaleString('he-IL', {style:'currency', currency:'ILS'})}</div>
      <div class="item"><strong>🏛️ פיקדון (4%):</strong> ${data.deposit.toLocaleString('he-IL', {style:'currency', currency:'ILS'})}</div>
      <div class="item"><strong>🎓 קרן השתלמות:</strong> ${data.savingsFund.toLocaleString('he-IL', {style:'currency', currency:'ILS'})}</div>
      <div class="item"><strong>🛡️ קרן פנסיה:</strong> ${data.pensionFund.toLocaleString('he-IL', {style:'currency', currency:'ILS'})}</div>
      <div class="item"><strong>📈 סך נכסים נוכחי:</strong> ${data.totalAssets.toLocaleString('he-IL', {style:'currency', currency:'ILS'})}</div>
      <div class="item"><strong>📊 צמיחה:</strong> ${data.growth.toLocaleString('he-IL', {style:'currency', currency:'ILS'})}</div>
      <div class="item"><strong>📉 אחוז צמיחה:</strong> <span style="color:${growthColor}; font-weight: bold;">${growthPercentFormatted}</span></div>
      ${data.avgGrowth !== undefined ? `<div class="item"><strong>📅 צמיחה ממוצעת:</strong> ${data.avgGrowth.toLocaleString('he-IL', {style:'currency', currency:'ILS'})}</div>` : ''}
      ${data.notes ? `<div class="item notes ${notesClass}">${data.notes}</div>` : ''}
    `;

    if (containerId === 'container') {
      // דוח נוכחי - עטיפה בכרטיסיה
      container.innerHTML = `<div class="card">${innerHTML}</div>`;
    } else {
      // דוח היסטוריה - כבר עטוף בכרטיסיה (האלמנט עצמו הוא כרטיסיה)
      container.innerHTML = innerHTML;
    }
  }

  function parseGoogleSheetsData(response) {
    try {
      const row = response.table.rows[0].c;
      const data = {
        cash: row[0]?.v || 0,
        currentAcc: row[1]?.v || 0,
        deposit: row[2]?.v || 0,
        savingsFund: row[3]?.v || 0,
        pensionFund: row[4]?.v || 0,
        totalAssets: row[5]?.v || 0,
        growth: row[6]?.v || 0,
        growthPercentRaw: row[7]?.v || 0,
        peakGrowthDate: row[8]?.f || '—',
        avgGrowth: row[9]?.v || 0,
        notes: row[10]?.v || 'אין הערות',
        notesStatus: (row[10]?.v || '').includes('✅') ? 'positive' : 'negative'
      };
      renderCard(data, 'container');
    } catch (err) {
      document.getElementById('container').innerHTML = '<p class="error">שגיאה בעיבוד הנתונים</p>';
    }
  }

  function parseHistoryData(response) {
    try {
      const rows = response.table.rows;
      historyData = rows.map(row => {
        const c = row.c;
        return {
          date: c[0]?.f || c[0]?.v || '—',
          cash: c[1]?.v || 0,
          currentAcc: c[2]?.v || 0,
          deposit: c[3]?.v || 0,
          savingsFund: c[4]?.v || 0,
          pensionFund: c[5]?.v || 0,
          totalAssets: c[6]?.v || 0,
          growth: c[7]?.v || 0,
          growthPercentRaw: c[8]?.v || 0,
        };
      });

      populateDateSelect();
    } catch (err) {
      document.getElementById('history-view').innerHTML = '<p class="error">שגיאה בעיבוד נתוני ההיסטוריה</p>';
    }
  }

  function populateDateSelect() {
    const select = document.getElementById('dateSelect');
    select.innerHTML = '<option value="" disabled selected>בחר תאריך</option>';
    historyData.forEach((item, index) => {
      const option = document.createElement('option');
      option.value = index;
      option.textContent = item.date;
      select.appendChild(option);
    });
  }

  function onDateChange() {
    const select = document.getElementById('dateSelect');
    const idx = select.value;
    if (idx !== '') {
      const data = historyData[idx];
      if (data) {
        document.getElementById('history-card').style.display = 'block';
        renderCard(data, 'history-card');
      }
    }
  }

  function loadHistoryData() {
    const script = document.createElement('script');
    script.src = "https://docs.google.com/spreadsheets/d/19dofQI-ay91ZAq40-fySZMdh_riryWmXGpqdbvqVb34/gviz/tq?tqx=out:jsonp&sheet=מעקב%20חסכונות&gid=353171664";
    script.onerror = () => {
      document.getElementById('history-view').innerHTML = '<p class="error">אירעה שגיאה בטעינת נתוני ההיסטוריה.</p>';
    };
    document.body.appendChild(script);

    window.google = { visualization: { Query: { setResponse: parseHistoryData } } };
  }

  // טעינת הדוח הנוכחי בהתחלה
  const script = document.createElement('script');
  script.src = "https://docs.google.com/spreadsheets/d/19dofQI-ay91ZAq40-fySZMdh_riryWmXGpqdbvqVb34/gviz/tq?tqx=out:jsonp&sheet=סיכום%20חסכונות&gid=425922794";
  script.onerror = () => {
    document.getElementById('container').innerHTML = '<p class="error">אירעה שגיאה בטעינת הדו"ח.</p>';
  };
  document.body.appendChild(script);

  window.google = { visualization: { Query: { setResponse: parseGoogleSheetsData } } };
</script>

</body>
</html>
